<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Leaflet Heatmap of teaching Jobs</title>
  <style>
    body,
    html {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    body {
      font-family: sans-serif;
    }

    body * {
      font-weight: 200;
    }

    h1 {
      position: absolute;
      background: white;
      padding: 10px;
    }

    #map {
      height: 100%;
    }

    .leaflet-container {
      background: rgba(0, 0, 0, .8) !important;
    }

    h1 {
      position: absolute;
      background: black;
      color: white;
      padding: 10px;
      font-weight: 200;
      z-index: 10000;
    }

    #all-examples-info {
      position: absolute;
      background: white;
      font-size: 16px;
      padding: 20px;
      top: 100px;
      width: 350px;
      line-height: 150%;
      border: 1px solid rgba(0, 0, 0, .2);
    }

    .my-label {
      position: absolute;
      opacity: 0.5 !important;
      pointer-events: auto !important;
    }

    .my-label:hover {
      position: absolute;
      opacity: 1 !important;
    }

    #buttonContainer {
      position: absolute;
      z-index: 99999;
      margin-left: 2%;
      margin-top: 1.4%;
    }

    .ui-tooltip {
      z-index: 99999;
      margin-left: 2%;
      margin-top: -1%;
    }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-label@0.2.1-0/dist/leaflet.label.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/Robonau/heatpub@main/heatmap.js-2.0.5/build/heatmap.js"></script>
  <script
    src="https://cdn.jsdelivr.net/gh/Robonau/heatpub@main/heatmap.js-2.0.5/plugins/leaflet-heatmap/leaflet-heatmap.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery-ui-dist@1.12.1/jquery-ui.js"></script>
</head>

<body>
  <div id='buttonContainer'>
    <button id="all" onclick="allASL('count')">All</button>
    <button id="State" onclick="allASL('countstate')">State</button>
    <button id="Independent" onclick="allASL('countind')">Independent</button>
    <button id="labelsTogg" title="click on a label to cycle between La name, no. jobs, no. state, no. independant"
      onclick="labelsTogg()">labels toggle</button>
  </div>
  <div id="map"></div>
  <script>
    window.onload = async function () {

      $('#labelsTogg').tooltip()

      const res = await fetch('https://raw.githubusercontent.com/Robonau/heatpub/main/heatmap.js-2.0.5/LAList.json')
      data = await res.json()

      const testData = {
        max: 10000,
        data: data.map(ele => {
          return {
            count: ele.count,
            long: ele.long,
            lat: ele.lat
          }
        })
      };

      const baseLayer = L.tileLayer(
        'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>',
        maxZoom: 18
      }
      );

      const cfg = {
        // radius should be small ONLY if scaleRadius is true (or small radius is intended)
        "radius": 0.45,
        "maxOpacity": .8,
        "scaleRadius": true,
        "useLocalExtrema": true,
        latField: 'lat',
        lngField: 'long',
        valueField: 'count'
      };


      const heatmapLayer = new HeatmapOverlay(cfg);

      map = new L.Map('map', {
        center: new L.LatLng(53, -2),
        zoom: 7,
        layers: [baseLayer, heatmapLayer]
      });

      heatmapLayer.setData(testData);

      layer = heatmapLayer;

      marker = {}
      ASLType = 'all'
      data.forEach(ele => {
        marker[ele.LA] = new L.marker([ele.lat, ele.long], { opacity: 0 });
        marker[ele.LA].bindTooltip(`${ele.LA}`, { interactive: true, permanent: true, className: "my-label", id: ele.LA, offset: [0, 0] });
        marker[ele.LA].addTo(map);
        marker[ele.LA].on('click', markerClick)
      })

      map.doubleClickZoom.disable();

      size()
      function size() {
        let newzoom = '' + (4 * (map.getZoom() - 6));
        newzoom = newzoom < 10 ? 10 : newzoom;
        console.log(newzoom)
        $('#map .my-label').css({ 'font-size': newzoom + 'px' });
      }

      map.on('zoomend', function () {
        size()
      });

    };
  </script>
  <script>

    function labelsTogg(e) {
      togglee = typeof togglee == 'undefined' || !togglee ? 1 : 0
      if (togglee) {
        data.forEach(ele => {
          map.removeLayer(marker[ele.LA])
        })
      } else {
        data.forEach(ele => {
          marker[ele.LA].addTo(map);
        })
      }
    }

    async function allASL(ASL) {
      let testData = {
        max: 10000,
        data: data.map(ele => {
          return {
            count: ele[ASL],
            long: ele.long,
            lat: ele.lat
          }
        })
      };

      layer.setData(testData)
      ASLType = ASL
    }

    function markerClick(e) {
      toggle = typeof toggle == 'undefined' ? 1 : toggle >= 3 ? 0 : toggle + 1
      console.log(e)
      let id = e.target._tooltip.options.id
      let stu = data.find(ele => ele.LA == id)
      switch (toggle) {
        case 0:
          e.target._tooltip.setContent(`All:${stu.count}`)
          break;
        case 1:
          e.target._tooltip.setContent(`State:${stu.countstate}`)
          break;
        case 2:
          e.target._tooltip.setContent(`Independent:${stu.countind}`)
          break;
        case 3:
          e.target._tooltip.setContent(`${stu.LA}`)
          break;
      }//\nIndependent:${stu.countind}\nState:${stu.countstate}\nAll:${stu.count}
      preventDefault()
    }
  </script>
</body>
</html>